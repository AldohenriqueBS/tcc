<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - ReservaAí</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo"><img src="./src/components/logo2.png" alt=""></div>
            
            <nav class="nav">
                <ul class="nav-list">
                    <li class="nav-item"><a href="index.html" class="nav-link active">Dashboard</a></li>
                    <li class="nav-item"><a href="quartos.html" class="nav-link">Quartos</a></li>
                    <li class="nav-item"><a href="clientes.html" class="nav-link">Clientes</a></li>
                    <li class="nav-item"><a href="reservas.html" class="nav-link">Reservas</a></li>
                    <li class="nav-item"><a href="financas.html" class="nav-link">Finanças</a></li>

                </ul>
            </nav>
            
            <div class="user-info">
                <span class="user-name">Olá, <span id="userName">Usuário</span></span>
                <button class="btn btn-logout" onclick="logout()">Sair</button>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="card">
            <h1 class="card-title">Dashboard</h1>
            
            <div class="grid">
                <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    <div class="stat-number" id="receitaTotal">R$ 0,00</div>
                    <div class="stat-label">Receita Total (Últimos 30 dias)</div>
                </div>
                
                <div class="stat-card" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                    <div class="stat-number" id="despesaTotal">R$ 0,00</div>
                    <div class="stat-label">Despesas Totais (Últimos 30 dias)</div>
                </div>
                
                <div class="stat-card" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                    <div class="stat-number" id="taxaOcupacao">0%</div>
                    <div class="stat-label">Taxa de Ocupação Média</div>
                </div>
                
                <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                    <div class="stat-number" id="totalClientes">0</div>
                    <div class="stat-label">Total de Clientes Cadastrados</div>
                </div>
            </div>
        </div>

        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 24px;">
            <div class="card">
                <h2 class="card-title">Movimentação Financeira (Receitas vs Despesas)</h2>
                <canvas id="movimentacaoFinanceiraChart"></canvas>
            </div>
            <div class="card">
                <h2 class="card-title">Ocupação por Tipo de Quarto</h2>
                <canvas id="ocupacaoQuartosChart"></canvas>
            </div>
        </div>

        <div class="card">
            <h2 class="card-title">Reservas Recentes</h2>
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>Carregando dados...</p>
            </div>
            <div class="table-container">
                <table class="table" id="reservasTable">
                    <thead>
                        <tr>
                            <th>Cliente</th>
                            <th>Quarto</th>
                            <th>Check-in</th>
                            <th>Check-out</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="reservasTableBody">
                        <tr>
                            <td colspan="5" class="text-center">Nenhuma reserva encontrada</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { db } from './firebase-config.js';
        import { collection, getDocs, query, orderBy, limit, where } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

        // Verifica autenticação
        if (!localStorage.getItem('userId')) {
            window.location.href = 'login.html';
        }

        // Exibe nome do usuário
        const userName = localStorage.getItem('userName') || 'Usuário';
        document.getElementById('userName').textContent = userName;

        // Função de logout
        window.logout = function() {
            localStorage.clear();
            window.location.href = 'login.html';
        };

        let movimentacaoFinanceiraChart = null;
        let ocupacaoQuartosChart = null;

        // Carrega todos os dados necessários
        async function loadAllData() {
            const [reservasSnap, quartosSnap, clientesSnap, despesasSnap] = await Promise.all([
                getDocs(collection(db, 'reservas')),
                getDocs(collection(db, 'quartos')),
                getDocs(collection(db, 'clientes')),
                getDocs(collection(db, 'despesas'))
            ]);

            const todasReservas = reservasSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const todosQuartos = quartosSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const todosClientes = clientesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const todasDespesas = despesasSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            return { todasReservas, todosQuartos, todosClientes, todasDespesas };
        }

        // Renderiza os Gráficos
        function renderDashboard(data) {
            const { todasReservas, todosQuartos, todosClientes, todasDespesas } = data;
            
            const hoje = new Date();
            const trintaDiasAtras = new Date();
            trintaDiasAtras.setDate(hoje.getDate() - 30);

            // Filtra dados dos últimos 30 dias
            const reservas30Dias = todasReservas.filter(r => {
                if (!r.checkIn || !r.checkIn.seconds) return false;
                const checkInDate = new Date(r.checkIn.seconds * 1000);
                return checkInDate >= trintaDiasAtras && checkInDate <= hoje;
            });

            const despesas30Dias = todasDespesas.filter(d => {
                if (!d.dataEmissao || !d.dataEmissao.seconds) return false;
                const dataEmissao = new Date(d.dataEmissao.seconds * 1000);
                return dataEmissao >= trintaDiasAtras && dataEmissao <= hoje;
            });

            // --- KPIs (Key Performance Indicators) ---

        // Calcula a 'receitaTotal':
        // 1. Filtra o array 'reservas30Dias', mantendo apenas as reservas que NÃO estão canceladas.
        // 2. Soma os valores. 'sum' é o acumulador e 'r' é a reserva atual.
        // 3. garante que, se 'valorTotal' for nulo ou indefinido, 0 será somado em vez de causar um erro.
        const receitaTotal = reservas30Dias.filter(r => r.status !== 'cancelada').reduce((sum, r) => sum + (r.valorTotal || 0), 0);
        
        // Calcula a 'despesaTotal':
        // 1. Soma o campo 'valor' de todas as 'despesas30Dias'.
        const despesaTotal = despesas30Dias.reduce((sum, d) => sum + (d.valor || 0), 0);
        
        // Calcula o 'totalClientes':
        // 1. Conta quantos itens existem no array 'todosClientes'
        const totalClientes = todosClientes.length;
        
        // Calcula a 'taxaOcupacao':
        // 1. Filtra 'todosQuartos' para encontrar aqueles com status 'ocupado' e conta quantos são
        const quartosOcupados = todosQuartos.filter(q => q.status === 'ocupado').length;
        // 2. Calcula a porcentagem. Usa um operador ternário para evitar divisão por zero
        //    if o total de quartos for maior que 0, calcula (quartosOcupados / todosQuartos.length * 100).
        //    else, o resultado é 0.
        const taxaOcupacao = todosQuartos.length > 0 ? (quartosOcupados / todosQuartos.length * 100) : 0;

        // --- Elementos HTML (KPIs) ---
        // Pega o elemento HTML com id 'receitaTotal' e atualiza seu texto.
        // Formata o número para ter 2 casas decimais
        // Troca o ponto decimal por vírgula
        document.getElementById('receitaTotal').textContent = `R$ ${receitaTotal.toFixed(2).replace('.', ',')}`;
        document.getElementById('despesaTotal').textContent = `R$ ${despesaTotal.toFixed(2).replace('.', ',')}`;
        document.getElementById('totalClientes').textContent = totalClientes;
        // Formata a taxa de ocupação para 1 casa decimal
        document.getElementById('taxaOcupacao').textContent = `${taxaOcupacao.toFixed(1)}%`;

        // --- Gráficos ---
        // Chama as funções que criam/atualizam os gráficos, passando os dados.
        renderMovimentacaoFinanceiraChart(receitaTotal, despesaTotal);
        renderOcupacaoQuartosChart(todosQuartos);
    }

     // Renderiza o gráfico de barras de Receitas vs Despesas.
    function renderMovimentacaoFinanceiraChart(receitas, despesas) {
        // Pega o elemento <canvas> onde o gráfico será desenhado.
        const ctx = document.getElementById('movimentacaoFinanceiraChart');
        // Verifica se o gráfico já existe.
        // Se sim, '.destroy()' remove o gráfico anterior para evitar bugs e sobreposições.
        if (movimentacaoFinanceiraChart) movimentacaoFinanceiraChart.destroy();
        
        // Cria uma nova instância do Chart.js.
        movimentacaoFinanceiraChart = new Chart(ctx, {
            type: 'bar', // Define o tipo de gráfico como "barras".
            data: {
                labels: ['Receitas', 'Despesas'], // Rótulos do eixo X.
                datasets: [{
                    label: 'Valor (R$)', // Rótulo que aparece na legenda/tooltip.
                    data: [receitas, despesas], // Os dados (valores) para cada barra.
                    backgroundColor: ['rgba(16, 185, 129, 0.8)', 'rgba(239, 68, 68, 0.8)'] // Cores das barras.
                }]
            },
            options: { // Opções de configuração do gráfico.
                responsive: true, // Torna o gráfico responsivo (se adapta ao tamanho do container).
                scales: { y: { beginAtZero: true } } // Configura o eixo Y para começar no valor 0.
            }
        });
    }


     // Renderiza/atualiza o gráfico de rosca (doughnut) com o status dos quartos.
    function renderOcupacaoQuartosChart(quartos) {
        // Agrupa e conta os quartos por status.
        // '.reduce' transforma o array 'quartos' em um objeto de contagem.
        // 'acc' é o objeto. 'q' é o quarto atual.
        //  Pega a contagem atual para o status 
        const statusCounts = quartos.reduce((acc, q) => {
            acc[q.status] = (acc[q.status] || 0) + 1;
            return acc;
        }, {});

        // Define os rótulos para o gráfico 
        const labels = ['Disponível', 'Ocupado', 'Manutenção'];
        // Cria o array de dados (valores) buscando as contagens do objeto 'statusCounts'.
        const data = [
            statusCounts['disponivel'] || 0,
            statusCounts['ocupado'] || 0,
            statusCounts['manutencao'] || 0
        ];

        // Pega o <canvas> do gráfico de ocupação.
        const ctx = document.getElementById('ocupacaoQuartosChart');
        // Destrói o gráfico anterior, se ele já existir.
        if (ocupacaoQuartosChart) ocupacaoQuartosChart.destroy();
        
        // Cria uma nova instância do Chart.js.
        ocupacaoQuartosChart = new Chart(ctx, {
            type: 'doughnut', // Define o tipo como "rosca" (pizza com buraco no meio).
            data: { 
                labels, // Usa os rótulos definidos acima.
                datasets: [{ 
                    label: 'Status de Quartos', 
                    data, // Usa os dados (contagens) definidos acima.
                    backgroundColor: ['#10B981', '#EF4444', '#F59E0B'] // Cores para cada fatia.
                }] 
            },
            options: { // Opções de configuração.
                responsive: true, 
                plugins: { legend: { position: 'top' } } // Move a legenda para o topo do gráfico.
            }
        });
    }       

        // Carrega reservas recentes
        async function loadRecentReservations(todasReservas) {
            const loading = document.getElementById('loading');
            const tableBody = document.getElementById('reservasTableBody');
            
            loading.classList.add('show');
            
            try {
                // Usar as reservas já carregadas e ordenar/limitar no cliente para simplificar
                const reservasRecentes = todasReservas
                    .sort((a, b) => (b.dataCriacao?.seconds || 0) - (a.dataCriacao?.seconds || 0))
                    .slice(0, 5);

                if (reservasRecentes.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center">Nenhuma reserva encontrada</td></tr>';
                    return;
                }

                tableBody.innerHTML = '';
                
                for (const reserva of reservasRecentes) {

                    const row = document.createElement('tr');
                    
                    // Formata as datas
                    const checkIn = reserva.checkIn ? new Date(reserva.checkIn.seconds * 1000).toLocaleDateString('pt-BR') : '-';
                    const checkOut = reserva.checkOut ? new Date(reserva.checkOut.seconds * 1000).toLocaleDateString('pt-BR') : '-';
                    
                    // Define a classe do badge de status
                    let statusClass = 'badge-primary';
                    if (reserva.status === 'ativa') statusClass = 'badge-success';
                    else if (reserva.status === 'cancelada') statusClass = 'badge-danger';
                    else if (reserva.status === 'finalizada') statusClass = 'badge-warning';
                    
                    row.innerHTML = `
                        <td>${reserva.nomeCliente || '-'}</td>
                        <td>${reserva.numeroQuarto || '-'}</td>
                        <td>${checkIn}</td>
                        <td>${checkOut}</td>
                        <td><span class="badge ${statusClass}">${reserva.status || '-'}</span></td>
                    `;
                    
                    tableBody.appendChild(row);
                }

            } catch (error) {
                console.error('Erro ao carregar reservas:', error);
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center">Erro ao carregar reservas</td></tr>';
            } finally {
                loading.classList.remove('show');
            }
        }

        // Carrega dados ao iniciar
        async function init() {
            try {
                const data = await loadAllData();
                renderDashboard(data);
                loadRecentReservations(data.todasReservas);
            } catch (error) {
                console.error('Erro fatal ao carregar Dashboard:', error);
                // Opcional: Adicionar um alerta ou mensagem de erro na tela
            }
        }

        init();
    </script>
</body>
</html>